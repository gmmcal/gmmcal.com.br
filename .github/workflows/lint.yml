name: Lint

on:
  - pull_request

env:
  RUBY_VERSION: '2.7.0'
  NODE_VERSION: '12.x'

jobs:
  rubocop:
    name: 'Lint: Rubocop'
    runs-on: ubuntu-18.04

    container:
      image: ruby:2.7.0

    steps:
      - uses: actions/checkout@v1

      # languages
      - name: Install APT dependencies
        run: |
          curl -sL https://deb.nodesource.com/setup_12.x | bash -
          curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
          apt-get -yqq install nodejs libpq-dev

      # dependencies
      - name: Run bundle install
        run: |
          bundle config set without test development production
          bundle install --jobs 4 --retry 3 --deployment

      - name: Run rubocop
        run: |
          bundle exec rubocop

  reek:
    name: 'Lint: Reek'
    runs-on: ubuntu-18.04

    container:
      image: ruby:2.7.0

    steps:
      - uses: actions/checkout@v1

      # languages
      - name: Install APT dependencies
        run: |
          curl -sL https://deb.nodesource.com/setup_12.x | bash -
          curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
          apt-get -yqq install nodejs libpq-dev

      # dependencies
      - name: Run bundle install
        run: |
          bundle config set without test development production
          bundle install --jobs 4 --retry 3 --deployment

      - name: Run reek
        run: |
          bundle exec reek

  brakeman:
    name: 'Lint: Brakeman'
    runs-on: ubuntu-18.04

    container:
      image: ruby:2.7.0

    steps:
      - uses: actions/checkout@v1

      # languages
      - name: Install APT dependencies
        run: |
          curl -sL https://deb.nodesource.com/setup_12.x | bash -
          curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
          apt-get -yqq install nodejs libpq-dev

      # dependencies
      - name: Run bundle install
        run: |
          bundle config set without test development production
          bundle install --jobs 4 --retry 3 --deployment

      - name: Run brakeman
        run: |
          bundle exec brakeman

  bundler-audit:
    name: 'Lint: Bundler Audit'
    runs-on: ubuntu-18.04

    container:
      image: ruby:2.7.0

    steps:
      - uses: actions/checkout@v1

      # languages
      - name: Install APT dependencies
        run: |
          curl -sL https://deb.nodesource.com/setup_12.x | bash -
          curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
          apt-get -yqq install nodejs libpq-dev

      # dependencies
      - name: Run bundle install
        run: |
          bundle config set without test development production
          bundle install --jobs 4 --retry 3 --deployment

      - name: Install Bundler Audit
        run: |
          gem install bundler-audit

      - name: Update advisory database
        run: |
          bundler-audit update

      - name: Run bundler-audit
        run: |
          bundler-audit

  scsslint:
    name: 'Lint: SCSSLint'
    runs-on: ubuntu-18.04

    container:
      image: ruby:2.7.0

    steps:
      - uses: actions/checkout@v1

      # languages
      - name: Install APT dependencies
        run: |
          curl -sL https://deb.nodesource.com/setup_12.x | bash -
          curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
          apt-get -yqq install nodejs libpq-dev

      # dependencies
      - name: Run bundle install
        run: |
          bundle config set without test development production
          bundle install --jobs 4 --retry 3 --deployment

      - name: Run SCSSLint
        run: |
          bundle exec scss-lint

  eslint:
    name: 'Lint: ESLint'
    runs-on: ubuntu-18.04

    container:
      image: ruby:2.7.0

    steps:
      - uses: actions/checkout@v1

      - name: Install APT dependencies
        run: |
          curl -sL https://deb.nodesource.com/setup_12.x | bash -
          curl -sL https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
          echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
          apt-get -yqq install nodejs

      - name: Install yarn
        run: npm i -g yarn

      - name: Run yarn install
        run: yarn install

      - name: Run ESLint
        run: yarn eslint
