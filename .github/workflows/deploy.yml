name: Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  tag:
    name: "Tag: Production"
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_tag.yml@v1
    concurrency:
      group: tag
      cancel-in-progress: false
    with:
      reference: ${{ github.sha }}

  release:
    name: Release
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_release.yml@v1
    needs:
      - tag
    with:
      tag: ${{needs.tag.outputs.version}}
      reference: ${{ github.sha }}

  build_development:
    name: Build
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_docker.yml@v1
    secrets:
      dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
    concurrency:
      group: build-development
      cancel-in-progress: true
    with:
      name: Development
      target: development
      image: "gmmcal/gmmcal:development"

  build_production:
    name: Build
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_docker.yml@v1
    needs:
      - tag
      - release
    secrets:
      dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
    concurrency:
      group: build-production
      cancel-in-progress: true
    with:
      name: Production
      target: production
      reference: ${{needs.tag.outputs.version}}
      image: "gmmcal/gmmcal:production"

  deploy:
    name: Deploy
    uses: gmmcal/gmmcal-reusable-workflows/.github/workflows/_deploy.yml@v1
    needs:
      - tag
      - release
    with:
      name: Production
      environment: production
      url: https://www.gustavocunha.dev
      tag: ${{ needs.tag.outputs.version }}
    secrets:
      dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}
      ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      rails-master-key: ${{ secrets.RAILS_MASTER_KEY }}
      database-host: ${{ secrets.DATABASE_HOST }}
      postgres-user: ${{ secrets.POSTGRES_USER }}
      postgres-password: ${{ secrets.POSTGRES_PASSWORD }}
      postgres-db: ${{ secrets.POSTGRES_DB }}
