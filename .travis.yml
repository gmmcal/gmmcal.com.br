language: ruby

dist: xenial

services:
  - postgresql

addons:
  postgresql: "10"

cache:
  directories:
    - ~/.rvm
    - ~/.npm
    - ~/.cache
    - .node_modules

before_install:
  - gem update --system --force

jobs:
  include:
    - stage: deploy
      script: skip
      deploy: &heroku
        provider: heroku
        app: gmmcal-dev
        api_key: $HEROKU_AUTH_TOKEN
        run:
          - "rails db:migrate"
          - "rails db:seed:all"
          - "rails db:cache:clear"
        on:
          branch: master

    - stage: deploy
      script: skip
      deploy: &heroku
        provider: heroku
        app: gmmcal
        api_key: $HEROKU_AUTH_TOKEN
        run:
          - "rails db:migrate"
          - "rails db:cache:clear"
        on:
          all_branches: true
          tags: true

bundler_args: --without production
